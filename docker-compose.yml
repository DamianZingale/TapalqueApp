services:
  # ==========================================
  # IMAGEN BASE JAVA
  # ==========================================
  base-java:
    build:
      context: ./portal Backend/base-java-image
      dockerfile: Dockerfile
    image: tapalque-base-java:latest
    container_name: base-java
    profiles: ['base']

  # ==========================================
  # INFRAESTRUCTURA
  # ==========================================
  rabbitmq:
    image: rabbitmq:3.13-alpine
    container_name: rabbitmq
    ports:
      - '5672:5672' # Comunicación interna
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'ping']
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 120s
    mem_limit: 1g
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    networks:
      - tapalque-net

  # Bases de datos Mongo
  pedidos-db:
    image: mongo:latest
    container_name: pedidos-db
    ports:
      - '27017:27017'
    volumes:
      - pedidos_data:/data/db
      - ./portal Backend/init-scripts/mongo/init-pedidos.js:/docker-entrypoint-initdb.d/init-pedidos.js:ro
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  reservas-db:
    image: mongo:latest
    container_name: reservas-db
    ports:
      - '27018:27017'
    volumes:
      - reservas_data:/data/db
      - ./portal Backend/init-scripts/mongo/init-reservas.js:/docker-entrypoint-initdb.d/init-reservas.js:ro
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  # Bases de datos MySQL
  gastronomia-db:
    image: mysql:8
    container_name: gastronomia-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: gastronomia
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3305:3306'
    volumes:
      - gastronomia_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-gastronomia.sql:/docker-entrypoint-initdb.d/init-gastronomia.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  hosteleria-db:
    image: mysql:8
    container_name: hosteleria-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: hosteleria
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3307:3306'
    volumes:
      - hosteleria_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-hosteleria.sql:/docker-entrypoint-initdb.d/init-hosteleria.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  mercado-pago-db:
    image: mysql:8
    container_name: mercado-pago-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: mercado_pago
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3308:3306'
    volumes:
      - mercado_pago_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-mercado-pago.sql:/docker-entrypoint-initdb.d/init-mercado-pago.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  jwt-db:
    image: mysql:8
    container_name: jwt-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: jwt
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3309:3306'
    volumes:
      - jwt_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-jwt.sql:/docker-entrypoint-initdb.d/init-jwt.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

  user-db:
    image: mysql:8
    container_name: user-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: user
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3310:3306'
    volumes:
      - user_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-user.sql:/docker-entrypoint-initdb.d/init-user.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  comercio-db:
    image: mysql:8
    container_name: comercio-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: comercio
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3311:3306'
    volumes:
      - comercio_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-comercio.sql:/docker-entrypoint-initdb.d/init-comercio.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

  eventos-db:
    image: mysql:8
    container_name: eventos-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: eventos
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3312:3306'
    volumes:
      - eventos_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-eventos.sql:/docker-entrypoint-initdb.d/init-eventos.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

  servicios-db:
    image: mysql:8
    container_name: servicios-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: servicios
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3313:3306'
    volumes:
      - servicios_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-servicios.sql:/docker-entrypoint-initdb.d/init-servicios.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

  termas-db:
    image: mysql:8
    container_name: termas-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: termas
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3314:3306'
    volumes:
      - termas_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-termas.sql:/docker-entrypoint-initdb.d/init-termas.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - tapalque-net

  espacios-publicos-db:
    image: mysql:8
    container_name: espacios-publicos-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: espacios_publicos
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - '3315:3306'
    volumes:
      - espacios_publicos_data:/var/lib/mysql
      - ./portal Backend/init-scripts/mysql/init-espacios-publicos.sql:/docker-entrypoint-initdb.d/init-espacios-publicos.sql:ro
    healthcheck:
      test:
        [
          'CMD',
          'mysqladmin',
          'ping',
          '-h',
          'localhost',
          '-u',
          '$$MYSQL_USER',
          '-p$$MYSQL_PASSWORD',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

  # ==========================================
  # MICROSERVICIOS
  # ==========================================
  eureka-server:
    build:
      context: ./portal Backend/eureka-server
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=tapalque-base-java:latest
    container_name: eureka-server
    ports:
      - '8761:8761'
    restart: always
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--quiet',
          '--tries=1',
          '--spider',
          'http://localhost:8761',
        ]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - tapalque-net

  msvc-gateway-server:
    build:
      context: ./portal Backend/msvc-gateway-server
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=tapalque-base-java:latest
    container_name: msvc-gateway-server
    ports:
      - '8090:8090'
    restart: always
    env_file:
      - .env
    environment:
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      eureka-server:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - tapalque-net

  msvc-jwt:
    build: ./portal Backend/msvc-jwt
    restart: always
    env_file:
      - .env
    depends_on:
      eureka-server:
        condition: service_healthy
      jwt-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-user:
    build: ./portal Backend/msvc-user
    depends_on:
      user-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    restart: always
    env_file:
      - .env
    volumes:
      - user_uploads:/app/uploads
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-pedidos:
    build: ./portal Backend/msvc-pedidos
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      JAVA_OPTS: '-Xmx192m -Xms96m -XX:+UseG1GC -XX:+UseContainerSupport -XX:MaxRAMPercentage=60.0'
    depends_on:
      pedidos-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-reservas:
    build: ./portal Backend/msvc-reservas
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      JAVA_OPTS: '-Xmx192m -Xms96m -XX:+UseG1GC -XX:+UseContainerSupport -XX:MaxRAMPercentage=60.0'
    depends_on:
      reservas-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-gastronomia:
    build: ./portal Backend/msvc-gastronomia
    env_file:
      - .env
    depends_on:
      gastronomia-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - gastronomia_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-hosteleria:
    build: ./portal Backend/msvc-hosteleria
    env_file:
      - .env
    depends_on:
      hosteleria-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - hosteleria_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-mercado-pago:
    build: ./portal Backend/msvc-mercado-pago
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    depends_on:
      mercado-pago-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    env_file:
      - .env
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-comercio:
    build: ./portal Backend/msvc-comercio
    env_file:
      - .env
    depends_on:
      comercio-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - comercio_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-eventos:
    build: ./portal Backend/msvc-eventos
    env_file:
      - .env
    depends_on:
      eventos-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - eventos_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-servicios:
    build: ./portal Backend/msvc-servicios
    env_file:
      - .env
    depends_on:
      servicios-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - servicios_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-termas:
    build: ./portal Backend/msvc-termas
    env_file:
      - .env
    depends_on:
      termas-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - termas_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  msvc-espacios-publicos:
    build: ./portal Backend/msvc-espacios-publicos
    env_file:
      - .env
    depends_on:
      espacios-publicos-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    volumes:
      - espacios_publicos_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    networks:
      - tapalque-net

  # ==========================================
  # FRONTEND - PUNTO DE ENTRADA PRINCIPAL
  # ==========================================
  frontend:
    # build y ports definidos en:
    # - docker-compose.override.yml para dev (image: node:20-slim, 3000:5173)
    # - docker-compose.prod.yml para producción (build: ./portal Frontend, 3000:80)
    container_name: frontend
    depends_on:
      - msvc-gateway-server
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - tapalque-net

# ==========================================
# VOLUMENES Y REDES
# ==========================================
volumes:
  rabbitmq_data:
  pedidos_data:
  reservas_data:
  gastronomia_data:
  gastronomia_uploads:
  hosteleria_data:
  hosteleria_uploads:
  mercado_pago_data:
  jwt_data:
  user_data:
  user_uploads:
  comercio_data:
  comercio_uploads:
  eventos_data:
  eventos_uploads:
  servicios_data:
  servicios_uploads:
  termas_data:
  termas_uploads:
  espacios_publicos_data:
  espacios_publicos_uploads:

networks:
  tapalque-net:
    driver: bridge
