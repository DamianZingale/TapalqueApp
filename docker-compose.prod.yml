# ==========================================
# PRODUCCION - Optimizado para 16GB RAM
# Dominio: www.tapalqueapp.com.ar
# Uso: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Servicios criticos con 2 replicas: user, jwt, mercado-pago, pedidos, reservas
# JVM tuneada con JAVA_TOOL_OPTIONS (funciona sin importar el ENTRYPOINT del Dockerfile)
# MySQL y MongoDB con caches reducidos
# Total estimado: ~12GB de 16GB disponibles
# ==========================================

x-java-opts-critical: &java-opts-critical
  JAVA_TOOL_OPTIONS: >-
    -Xmx256m -Xms128m
    -XX:+UseG1GC
    -XX:+UseContainerSupport
    -XX:MaxRAMPercentage=75.0
    -XX:+UseStringDeduplication
    -XX:MaxMetaspaceSize=128m
    -Xss256k

x-java-opts-light: &java-opts-light
  JAVA_TOOL_OPTIONS: >-
    -Xmx192m -Xms96m
    -XX:+UseSerialGC
    -XX:+UseContainerSupport
    -XX:MaxRAMPercentage=75.0
    -XX:MaxMetaspaceSize=96m
    -Xss256k

x-java-opts-infra: &java-opts-infra
  JAVA_TOOL_OPTIONS: >-
    -Xmx384m -Xms192m
    -XX:+UseG1GC
    -XX:+UseContainerSupport
    -XX:MaxRAMPercentage=75.0
    -XX:MaxMetaspaceSize=128m
    -Xss256k

x-mysql-tuned: &mysql-tuned
  command: >-
    --innodb-buffer-pool-size=64M
    --key-buffer-size=8M
    --max-connections=40
    --performance-schema=OFF
    --innodb-log-buffer-size=4M
    --innodb-flush-method=O_DIRECT
    --sort-buffer-size=256K
    --read-buffer-size=256K
    --thread-cache-size=4

services:
  # ==========================================
  # REVERSE PROXY + SSL (Let's Encrypt)
  # ==========================================
  nginx-proxy:
    build:
      context: ./nginx-proxy
      dockerfile: Dockerfile
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - letsencrypt_data:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    depends_on:
      - frontend
    restart: always
    deploy:
      resources:
        limits:
          memory: 64M
    networks:
      - tapalque-net

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - letsencrypt_data:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    # Renueva cada 12 horas si es necesario
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'"
    restart: always
    deploy:
      resources:
        limits:
          memory: 64M
    networks:
      - tapalque-net

  # ==========================================
  # INFRAESTRUCTURA - Overrides
  # IMPORTANTE: Los puertos de DB/infra siguen mapeados del base compose.
  # En el VPS, configurar firewall (ufw) para solo permitir 80, 443 y 22.
  # ==========================================
  rabbitmq:
    deploy:
      resources:
        limits:
          memory: 256M

  pedidos-db:
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    command: --wiredTigerCacheSizeGB=0.25

  reservas-db:
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M
    command: --wiredTigerCacheSizeGB=0.25

  gastronomia-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  hosteleria-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  mercado-pago-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  jwt-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  user-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  comercio-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  eventos-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  servicios-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  termas-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  espacios-publicos-db:
    <<: *mysql-tuned
    restart: always
    deploy:
      resources:
        limits:
          memory: 384M

  # ==========================================
  # INFRAESTRUCTURA JAVA
  # ==========================================
  eureka-server:
    environment:
      <<: *java-opts-infra
    deploy:
      resources:
        limits:
          memory: 512M

  msvc-gateway-server:
    environment:
      <<: *java-opts-infra
    deploy:
      resources:
        limits:
          memory: 512M

  # ==========================================
  # SERVICIOS CRITICOS - 2 REPLICAS
  # Sin container_name para permitir replicas
  # Sin ports de host (acceso solo via gateway)
  # ==========================================
  msvc-jwt:
    environment:
      <<: *java-opts-critical
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 384M

  msvc-user:
    environment:
      <<: *java-opts-critical
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 384M

  msvc-pedidos:
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      <<: *java-opts-critical
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 384M

  msvc-reservas:
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      <<: *java-opts-critical
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 384M

  msvc-mercado-pago:
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      <<: *java-opts-critical
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 384M

  # ==========================================
  # SERVICIOS NO CRITICOS - 1 REPLICA
  # ==========================================
  msvc-gastronomia:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-hosteleria:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-comercio:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-eventos:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-servicios:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-termas:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  msvc-espacios-publicos:
    environment:
      <<: *java-opts-light
    deploy:
      resources:
        limits:
          memory: 300M

  # ==========================================
  # FRONTEND - Nginx en produccion (solo red interna)
  # Accesible unicamente via nginx-proxy
  # ==========================================
  frontend:
    build:
      context: ./portal Frontend
      dockerfile: Dockerfile
    deploy:
      resources:
        limits:
          memory: 128M

# ==========================================
# VOLUMENES ADICIONALES
# ==========================================
volumes:
  letsencrypt_data:
  certbot_www:
